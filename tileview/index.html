<!DOCTYPE html>
<html>

<head>
  <meta charset='utf-8' />
  <title>POC mapbox-gl</title>
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
  <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.40.0/mapbox-gl.js'></script>
  <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.40.0/mapbox-gl.css' rel='stylesheet' />
  <script src='http://mapbox-gl-inspect.lukasmartinelli.ch/dist/mapbox-gl-inspect.min.js'></script>
  <link href='http://mapbox-gl-inspect.lukasmartinelli.ch/dist/mapbox-gl-inspect.css' rel='stylesheet' />
  <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>

  <style>
    body {
      margin: 0;
      padding: 0;
    }

    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
    }

    #info {
      font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
      background-color: #fff;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.10);
      border-radius: 3px;
      position: absolute;
      width: 25%;
      top: 10px;
      left: 10px;
      padding: 10px;
    }
  </style>
</head>

<body>

  <div id='map'></div>
  <pre id='info'></pre>
  <script>
    var map = new mapboxgl.Map({
      container: 'map',
      style: 'osm-liberty.json',
      zoom: 14,
      center: [2.2900, 48.8719],
      hash: true
    });
    var nav_inspect = new MapboxInspect();
    map.addControl(nav_inspect, 'bottom-right');
    var nav_control = new mapboxgl.NavigationControl();
    map.addControl(nav_control, 'bottom-right');

    map.on('load', function() {

      map.on('mousemove', 'poi_z16', function(e) {
        // Change the cursor style as a UI indicator.
        map.getCanvas().style.cursor = 'pointer';
      });
      map.on('mouseleave', 'poi_z16', function() {
        map.getCanvas().style.cursor = '';
      });
      map.on('click', 'poi_z16', function(e) {
        // Single out the first found feature.
        var feature = e.features[0];

        var popup_content = feature.properties.name || "pas de nom :("

        if (feature.properties.class == "fuel") {
          var oedb_url = "http://api.openeventdatabase.org/event?what=fuel.price&when=last5minutes&near=" + e.lngLat.lng + "," + e.lngLat.lat + ",200"

          $(document).ready(function() {
            //$.getJSON("http://api.openeventdatabase.org/event?what=fuel.price&when=last5minutes&near=1.46593,47.90362,20000", function(geojsonFeatures) {
            $.getJSON(oedb_url, function(geojsonFeatures) {
              if (geojsonFeatures.features[0]) {
                console.log(geojsonFeatures.features[0]);
                if (geojsonFeatures.features[0].properties.distance < 50) {
                  document.getElementById('info').innerHTML = geojsonFeatures.features[0].properties.nom
                  document.getElementById('info').innerHTML += "<br> " + geojsonFeatures.features[0].properties.label;

                } else {
                  document.getElementById('info').innerHTML = "pas trouv√© de prix de carburants :(";

                }
              } else {
                document.getElementById('info').innerHTML = "station inconnue :(";

              }


            });
          });
        }


        // Display a popup
        var popup = new mapboxgl.Popup({
            closeButton: false
          }).setLngLat(e.lngLat)
          .setText(popup_content)
          .addTo(map);
      });


    });
  </script>

</body>

</html>
